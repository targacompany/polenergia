const INPUT_IDS={billInput:"billInput",energyActivePrice:"energyActivePrice",distributionPrice:"distributionPrice",resalePrice:"resalePrice",fixedCharges:"fixedCharges",priceGrowth:"priceGrowth",dynamicPrice:"dynamicPrice"},INSTALLATION_TABLE=[{pvKw:2.7,price:42990,storageKwh:5.8},{pvKw:3.15,price:45980,storageKwh:9.2},{pvKw:3.6,price:47980,storageKwh:9.2},{pvKw:4.05,price:49980,storageKwh:9.2},{pvKw:4.5,price:52230,storageKwh:9.2},{pvKw:4.95,price:54480,storageKwh:9.2},{pvKw:5.4,price:56730,storageKwh:9.2},{pvKw:5.85,price:58980,storageKwh:9.2},{pvKw:6.3,price:59980,storageKwh:9.2},{pvKw:6.75,price:60980,storageKwh:9.2},{pvKw:7.2,price:61980,storageKwh:9.2},{pvKw:7.65,price:62980,storageKwh:9.2},{pvKw:8.1,price:63980,storageKwh:9.2},{pvKw:8.55,price:64980,storageKwh:9.2},{pvKw:9,price:65980,storageKwh:9.2},{pvKw:9.45,price:66480,storageKwh:9.2},{pvKw:9.9,price:66980,storageKwh:9.2}],STORAGE_TABLE=[{storageKwh:6.1,pvMatchKw:4.066666667},{storageKwh:9.2,pvMatchKw:6.133333333},{storageKwh:12.2,pvMatchKw:8.133333333},{storageKwh:18.4,pvMatchKw:12.26666667},{storageKwh:24.4,pvMatchKw:16.26666667},{storageKwh:11.5,pvMatchKw:7.666666667},{storageKwh:17.3,pvMatchKw:11.53333333},{storageKwh:23,pvMatchKw:15.33333333},{storageKwh:34.6,pvMatchKw:23.06666667},{storageKwh:46.1,pvMatchKw:30.73333333}],CONSTANTS={minPvKw:2.7,pvStep:.45,pvLossFactor:.99,years:25,grantAmount:23e3,productionFactor:1.02,autoconsumptionRate:.7,moduleDegradation:.004,selectionFactor:.9,taxReliefRate:.32,dynamicPriceRate:.24},formatCurrency=e=>"number"==typeof e?e.toLocaleString("pl-PL",{minimumFractionDigits:2,maximumFractionDigits:2}):"",formatNumber=(e,t=2)=>"number"==typeof e?e.toLocaleString("pl-PL",{minimumFractionDigits:t,maximumFractionDigits:t}):"";function readNumber(e){const t=document.getElementById(e);if(!t)return 0;const r=t.value??t.textContent,a="string"==typeof r?parseFloat(r.replace(",",".")):Number(r);return Number.isFinite(a)?a:0}function readBoolean(e){const t=document.getElementById(e);if(!t)return!1;if("checked"in t)return Boolean(t.checked);const r=t.value??t.textContent;if("string"==typeof r){const e=r.trim().toLowerCase();return"true"===e||"1"===e||"yes"===e}return Boolean(r)}function readInputs(){return{billInput:readNumber(INPUT_IDS.billInput),energyActivePrice:readNumber(INPUT_IDS.energyActivePrice),distributionPrice:readNumber(INPUT_IDS.distributionPrice),resalePrice:readNumber(INPUT_IDS.resalePrice),fixedCharges:readNumber(INPUT_IDS.fixedCharges),priceGrowth:readNumber(INPUT_IDS.priceGrowth),dynamicPrice:readBoolean(INPUT_IDS.dynamicPrice)}}const mround=(e,t)=>t?Math.round(e/t)*t:e;function pickInstallation(e){if(!INSTALLATION_TABLE.length)return{pvKw:CONSTANTS.minPvKw,price:0,storageKwh:null};return INSTALLATION_TABLE.find(t=>e<=t.pvKw)||INSTALLATION_TABLE[INSTALLATION_TABLE.length-1]}function pickStorage(e){if(!STORAGE_TABLE.length)return null;let t=STORAGE_TABLE[0],r=Math.abs(t.pvMatchKw-e);for(let a=1;a<STORAGE_TABLE.length;a+=1){const i=STORAGE_TABLE[a],n=Math.abs(i.pvMatchKw-e);n<r&&(t=i,r=n)}return t}function buildProfitabilityTable(e,t){const r=[],{billInput:a,energyActivePrice:i,distributionPrice:n,resalePrice:o,priceGrowth:c}=e,{baseProduction:s,netInstallationCost:l,currentDemand:u}=t,p=1+c;let m=0,d=0,h=0,g=0;for(let e=0;e<CONSTANTS.years;e+=1){const t=e+1,c=Math.pow(p,e),w=a*c,v=12*w,K=i*c,T=n*c,N=o*c,S=K*CONSTANTS.dynamicPriceRate,b=s*(0===e?1:Math.max(1-CONSTANTS.moduleDegradation*t,0)),y=b*CONSTANTS.autoconsumptionRate,P=b-y,f=0===e?u-y:d+(m-P),I=y*(K+T)+P*N,A=I+f*S;h=0===e?-l+I:h+I,g=0===e?-l+A:g+A;const C=v-I,O=v-A;r.push({year:t,monthlyBill:w,yearlyBill:v,production:b,autoconsumption:y,exported:P,imported:f,activePrice:K,distributionPrice:T,resalePrice:N,dynamicPricePerKwh:S,savingsWithout:I,savingsWith:A,cumulativeWithout:h,cumulativeWith:g,pvBillWithout:C,pvBillWith:O}),m=P,d=f}return r}function computeResults(e){const t=Math.max(e.billInput-e.fixedCharges,0),r=e.energyActivePrice+e.distributionPrice,a=r>0?t/r*12:0,i=12*e.billInput,n=Math.max(CONSTANTS.minPvKw,mround(a*CONSTANTS.selectionFactor/1e3,CONSTANTS.pvStep)),o=1e3*n*CONSTANTS.pvLossFactor*CONSTANTS.productionFactor,c=pickInstallation(n).price||0,s=Math.max(c-CONSTANTS.grantAmount,0),l=s*(1-CONSTANTS.taxReliefRate),u=pickStorage(n),p=buildProfitabilityTable(e,{baseProduction:o,netInstallationCost:l,currentDemand:a}),m=p[0]||null,d=m?e.dynamicPrice?m.pvBillWith:m.pvBillWithout:i,h=i-d;let g=null;for(let e=0;e<p.length;e+=1)if(p[e].cumulativeWith>=0){g=p[e].year;break}return{currentDemand:a,baselineYearlyBill:i,yearlyBill:d,savings:h,recommendedPv:n,recommendedStorage:u?u.storageKwh:null,installationCost:c,installationCostWithGrant:s,netInstallationCost:l,baseProduction:o,table:p,firstYear:m,paybackYear:g}}function setOutput(e,t,r=null){const a=document.getElementById(e);if(!a)return;const i=r?r(t):t;"value"in a?(a.value=i,a.setAttribute("value",i)):a.textContent=i}function updateOutputs(e){setOutput("yearlyBill",e.yearlyBill,formatCurrency),setOutput("resultBill",e.yearlyBill/12,formatCurrency),setOutput("savings",e.savings,formatCurrency),setOutput("recommendation-photovoltaics",e.recommendedPv,e=>formatNumber(e,2)),setOutput("currentDemand",e.currentDemand,e=>Number.isFinite(e)?e.toFixed(2):""),null!==e.recommendedStorage&&setOutput("recommendation-storage",e.recommendedStorage,e=>formatNumber(e,1)),null!==e.paybackYear&&setOutput("investment-return",e.paybackYear,e=>formatNumber(e,0))}function dispatchResults(e,t){const r={inputs:e,results:{yearlyBill:t.yearlyBill,savings:t.savings,recommendedPv:t.recommendedPv,recommendedStorage:t.recommendedStorage,baseProduction:t.baseProduction,installationCost:t.installationCost,installationCostWithGrant:t.installationCostWithGrant,netInstallationCost:t.netInstallationCost,paybackYear:t.paybackYear,firstYear:t.firstYear,table:t.table}};window.polenergiaCalculator=r,document.dispatchEvent(new CustomEvent("polenergia:calculator:update",{detail:r}))}function recalculate(){const e=readInputs(),t=computeResults(e);updateOutputs(t),dispatchResults(e,t)}function attachListeners(){Object.values(INPUT_IDS).forEach(e=>{const t=document.getElementById(e);if(!t)return;const r=()=>recalculate();t.addEventListener("change",r),t.addEventListener("input",r)})}attachListeners(),recalculate(),window.polenergiaRecalculate=recalculate;