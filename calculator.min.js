const INPUT_IDS={billInput:"billInput",energyActivePrice:"energyActivePrice",distributionPrice:"distributionPrice",resalePrice:"resalePrice",fixedCharges:"fixedCharges",priceGrowth:"priceGrowth",dynamicPrice:"dynamicPrice"},INSTALLATION_TABLE=[{pvKw:2.7,price:42990,storageKwh:5.8},{pvKw:3.15,price:45980,storageKwh:9.2},{pvKw:3.6,price:47980,storageKwh:9.2},{pvKw:4.05,price:49980,storageKwh:9.2},{pvKw:4.5,price:52230,storageKwh:9.2},{pvKw:4.95,price:54480,storageKwh:9.2},{pvKw:5.4,price:56730,storageKwh:9.2},{pvKw:5.85,price:58980,storageKwh:9.2},{pvKw:6.3,price:59980,storageKwh:9.2},{pvKw:6.75,price:60980,storageKwh:9.2},{pvKw:7.2,price:61980,storageKwh:9.2},{pvKw:7.65,price:62980,storageKwh:9.2},{pvKw:8.1,price:63980,storageKwh:9.2},{pvKw:8.55,price:64980,storageKwh:9.2},{pvKw:9,price:65980,storageKwh:9.2},{pvKw:9.45,price:66480,storageKwh:9.2},{pvKw:9.9,price:66980,storageKwh:9.2}],STORAGE_TABLE=[{storageKwh:6.1,pvMatchKw:4.066666667},{storageKwh:9.2,pvMatchKw:6.133333333},{storageKwh:12.2,pvMatchKw:8.133333333},{storageKwh:18.4,pvMatchKw:12.26666667},{storageKwh:24.4,pvMatchKw:16.26666667},{storageKwh:11.5,pvMatchKw:7.666666667},{storageKwh:17.3,pvMatchKw:11.53333333},{storageKwh:23,pvMatchKw:15.33333333},{storageKwh:34.6,pvMatchKw:23.06666667},{storageKwh:46.1,pvMatchKw:30.73333333}],CONSTANTS={minPvKw:2.7,pvStep:.45,pvLossFactor:.99,years:25,grantAmount:23e3,productionFactor:1.02,autoconsumptionRate:.7,moduleDegradation:.004,selectionFactor:.9,taxReliefRate:.32,dynamicPriceRate:.24},formatCurrency=e=>"number"==typeof e?e.toLocaleString("pl-PL",{minimumFractionDigits:2,maximumFractionDigits:2}):"",formatNumber=(e,t=2)=>"number"==typeof e?e.toLocaleString("pl-PL",{minimumFractionDigits:t,maximumFractionDigits:t}):"";function readNumber(e){const t=document.getElementById(e);if(!t)return 0;const r=t.value??t.textContent,a="string"==typeof r?parseFloat(r.replace(",",".")):Number(r);return Number.isFinite(a)?a:0}function readBoolean(e){const t=document.getElementById(e);if(!t)return!1;if("checked"in t)return!!t.checked;const r=t.value??t.textContent;if("string"==typeof r){const e=r.trim().toLowerCase();return"true"===e||"1"===e||"yes"===e}return!!r}function readInputs(){const e=readNumber(INPUT_IDS.priceGrowth),t=e>1?e/100:e;return{billInput:readNumber(INPUT_IDS.billInput),energyActivePrice:readNumber(INPUT_IDS.energyActivePrice),distributionPrice:readNumber(INPUT_IDS.distributionPrice),resalePrice:readNumber(INPUT_IDS.resalePrice),fixedCharges:readNumber(INPUT_IDS.fixedCharges),priceGrowth:t,dynamicPrice:readBoolean(INPUT_IDS.dynamicPrice)}}const mround=(e,t)=>t?Math.round(e/t)*t:e;function pickInstallation(e){if(!INSTALLATION_TABLE.length)return{pvKw:CONSTANTS.minPvKw,price:0,storageKwh:null};return INSTALLATION_TABLE.find(t=>e<=t.pvKw)||INSTALLATION_TABLE[INSTALLATION_TABLE.length-1]}function pickStorage(e){if(!STORAGE_TABLE.length)return null;let t=STORAGE_TABLE[0],r=Math.abs(t.pvMatchKw-e);for(let a=1;a<STORAGE_TABLE.length;a+=1){const n=STORAGE_TABLE[a],o=Math.abs(n.pvMatchKw-e);o<r&&(t=n,r=o)}return t}function buildProfitabilityTable(e,t){const r=[],{billInput:a,energyActivePrice:n,distributionPrice:o,resalePrice:i,priceGrowth:c}=e,{baseProduction:s,netInstallationCost:l,currentDemand:u}=t,p=1+c;let m=0,d=0,h=0,f=0;for(let e=0;e<CONSTANTS.years;e+=1){const t=e+1,c=Math.pow(p,e),w=a*c,v=12*w,K=n*c,y=o*c,T=i*c,S=K*CONSTANTS.dynamicPriceRate,b=0===e?1:Math.max(1-CONSTANTS.moduleDegradation*t,0),P=s*b,g=P*CONSTANTS.autoconsumptionRate,I=P-g,A=0===e?u-g:d+(m-I),C=g*(K+y)+I*T,x=C+A*S;h=0===e?-l+C:h+C,f=0===e?-l+x:f+x;const N=w-C,O=w-x;r.push({year:t,monthlyBill:w,yearlyBill:v,production:P,autoconsumption:g,exported:I,imported:A,activePrice:K,distributionPrice:y,resalePrice:T,dynamicPricePerKwh:S,savingsWithout:C,savingsWith:x,cumulativeWithout:h,cumulativeWith:f,pvBillWithout:N,pvBillWith:O}),m=I,d=A}return r}function computeResults(e){const t=Math.max(e.billInput-e.fixedCharges,0),r=e.energyActivePrice+e.distributionPrice,a=r>0?t/r*12:0,n=12*e.billInput,o=Math.max(CONSTANTS.minPvKw,mround(a*CONSTANTS.selectionFactor/1e3,CONSTANTS.pvStep)),i=1e3*o*CONSTANTS.pvLossFactor*CONSTANTS.productionFactor,c=pickInstallation(o).price||0,s=Math.max(c-CONSTANTS.grantAmount,0),l=s*(1-CONSTANTS.taxReliefRate),u=pickStorage(o),p=buildProfitabilityTable(e,{baseProduction:i,netInstallationCost:l,currentDemand:a}),m=p[0]||null,d=m?e.dynamicPrice?m.pvBillWith:m.pvBillWithout:n,h=n-d;let f=null;const w=e.dynamicPrice?"cumulativeWith":"cumulativeWithout";for(let e=0;e<p.length;e+=1)if(p[e][w]>=0){f=p[e].year;break}return{currentDemand:a,baselineYearlyBill:n,yearlyBill:d,savings:h,recommendedPv:o,recommendedStorage:u?u.storageKwh:null,installationCost:c,installationCostWithGrant:s,netInstallationCost:l,baseProduction:i,table:p,firstYear:m,paybackYear:f}}function setOutput(e,t,r=null){const a=document.getElementById(e);if(!a)return;const n=r?r(t):t;"value"in a?(a.value=n,a.setAttribute("value",n)):a.textContent=n}function updateOutputs(e){setOutput("yearlyBill",e.yearlyBill,formatCurrency),setOutput("resultBill",e.yearlyBill/12,t=>Number.isFinite(t)?t.toFixed(2):""),setOutput("savings",e.savings,formatCurrency),setOutput("recommendation-photovoltaics",e.recommendedPv,t=>formatNumber(t,2)),setOutput("currentDemand",e.currentDemand,t=>Number.isFinite(t)?t.toFixed(2):""),null!==e.recommendedStorage&&setOutput("recommendation-storage",e.recommendedStorage,t=>formatNumber(t,1)),null!==e.paybackYear&&setOutput("investment-return",e.paybackYear,t=>formatNumber(t,0))}function dispatchResults(e,t){const r={inputs:{...e,currentDemand:t.currentDemand},results:{yearlyBill:t.yearlyBill,savings:t.savings,recommendedPv:t.recommendedPv,recommendedStorage:t.recommendedStorage,baseProduction:t.baseProduction,installationCost:t.installationCost,installationCostWithGrant:t.installationCostWithGrant,netInstallationCost:t.netInstallationCost,paybackYear:t.paybackYear,firstYear:t.firstYear,table:t.table}};window.polenergiaCalculator=r,document.dispatchEvent(new CustomEvent("polenergia:calculator:update",{detail:r}))}function recalculate(){const e=readInputs(),t=computeResults(e);updateOutputs(t),dispatchResults(e,t)}function attachListeners(){Object.values(INPUT_IDS).forEach(e=>{const t=document.getElementById(e);if(t){const r=()=>recalculate();t.addEventListener("change",r),t.addEventListener("input",r)}})}const init=()=>{attachListeners(),recalculate()};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",init,{once:!0}):init(),window.polenergiaRecalculate=recalculate;
